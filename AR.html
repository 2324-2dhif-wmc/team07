<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        #debug-info {
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div id="debug-info">Distance: N/A</div>

<script>
    // Request location permissions on page load
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('GPS permission granted', position);

                    // Initialize AR scene after permission is granted
                    initARScene();
                },
                function(error) {
                    console.error('Error requesting GPS permission', error);
                    alert('GPS permission is required to use this application.');
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    };

    // Initialize AR scene
    function initARScene() {
        AFRAME.registerComponent('check-distance', {
            tick: function() {
                var textEntity = document.querySelector('#info-text');
                var debugInfo = document.querySelector('#debug-info');

                // Get the GPS position of the camera and the entity
                var cameraPosition = this.el.components['gps-camera'].currentCoords;
                var entityPosition = textEntity.components['gps-entity-place'].attrValue;

                // Calculate the distance using the Haversine formula
                if (cameraPosition && entityPosition) {
                    var distance = calculateDistance(cameraPosition.latitude, cameraPosition.longitude, entityPosition.latitude, entityPosition.longitude);
                    debugInfo.innerHTML = 'Distance: ' + distance.toFixed(2) + ' meters';

                    // Toggle visibility based on distance
                    if (distance <= 5) {
                        textEntity.setAttribute('visible', true);
                    } else {
                        textEntity.setAttribute('visible', false);
                    }
                } else {
                    debugInfo.innerHTML = 'Distance: calculating...';
                }
            }
        });

        // Calculate the distance between two points using the Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // metres
            var φ1 = lat1 * Math.PI/180;
            var φ2 = lat2 * Math.PI/180;
            var Δφ = (lat2-lat1) * Math.PI/180;
            var Δλ = (lon2-lon1) * Math.PI/180;

            var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            var d = R * c; // in metres
            return d;
        }

        // Add AR camera to the scene
        var scene = document.querySelector('a-scene');
        var camera = document.createElement('a-camera');
        camera.setAttribute('gps-camera', 'gpsMinDistance: 5');
        camera.setAttribute('rotation-reader', '');
        camera.setAttribute('check-distance', '');
        scene.appendChild(camera);
    }
</script>

<a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
>
    <a-text
            id="info-text"
            value="Stair"
            look-at="[gps-camera]"
            scale="10 10 10"
            gps-entity-place="latitude: 48.1399; longitude: 14.2360;"
            visible="false"
    ></a-text>
</a-scene>

</body>
</html>
