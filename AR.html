<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        #debug-info {
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div id="debug-info">Distance: N/A</div>

<script>
    window.onload = function() {
        requestGPS();
    };

    let componentRegistered = false;

    function requestGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                function(position) {
                    if (!componentRegistered) {
                        initARScene(position.coords);
                    }
                },
                function(error) {
                    handleGPSError(error);
                },
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    function handleGPSError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                alert('GPS permission is required to use this application.');
                break;
            case error.POSITION_UNAVAILABLE:
                alert('Location information is unavailable. Please ensure your GPS is enabled.');
                break;
            case error.TIMEOUT:
                alert('The request to get user location timed out. Retrying...');
                setTimeout(requestGPS, 10000);
                break;
            default:
                alert('An unknown error occurred. Please try again.');
                break;
        }
    }

    function initARScene(initialCoords) {
        if (!componentRegistered) {
            AFRAME.registerComponent('check-distance', {
                tick: function() {
                    var boxEntity = document.querySelector('#info-box');
                    var debugInfo = document.querySelector('#debug-info');

                    var cameraPosition = this.el.components['gps-camera'].currentCoords;
                    var entityPosition = boxEntity.components['gps-entity-place'].attrValue;

                    if (cameraPosition && entityPosition) {
                        var distance = calculateDistance(cameraPosition.latitude, cameraPosition.longitude, entityPosition.latitude, entityPosition.longitude);
                        debugInfo.innerHTML = 'Distance: ' + distance.toFixed(2) + ' meters';
                        console.log('Camera Position:', cameraPosition);
                        console.log('Entity Position:', entityPosition);
                        console.log('Distance:', distance);

                        // Make the entity always visible for debugging purposes
                        boxEntity.setAttribute('visible', true);
                        console.log('Entity is visible');
                    } else {
                        debugInfo.innerHTML = 'Distance: calculating...';
                        console.log('Calculating distance...');
                    }
                }
            });
            componentRegistered = true;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // metres
            var φ1 = lat1 * Math.PI / 180;
            var φ2 = lat2 * Math.PI / 180;
            var Δφ = (lat2 - lat1) * Math.PI / 180;
            var Δλ = (lon2 - lon1) * Math.PI / 180;

            var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            var d = R * c; // in metres
            return d;
        }

        var scene = document.querySelector('a-scene');
        var camera = document.createElement('a-camera');
        camera.setAttribute('gps-camera', 'gpsMinDistance: 0; maxDistance: 10000');
        camera.setAttribute('rotation-reader', '');
        camera.setAttribute('check-distance', '');
        scene.appendChild(camera);
    }
</script>

<a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
>
    <a-camera
            id="camera"
            gps-camera="gpsMinDistance: 0; maxDistance: 10000"
            rotation-reader=""
            check-distance=""
            rotation="0 0 0"
    ></a-camera>
    <a-box
            id="info-box"
            color="red"
            depth="1"
            height="1"
            width="1"
            look-at="[gps-camera]"
            scale="10 10 10"
            gps-entity-place="latitude: 48.1401107; longitude: 14.2360109;"
            visible="true"
    ></a-box>
</a-scene>

</body>
</html>
