<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js Demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        #debug-info {
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            z-index: 1000;
        }
        #end-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 1001;
        }
    </style>
</head>
<body>
<div id="debug-info">Distance: N/A</div>
<div id="end-screen">You reached the point in <span id="time-taken"></span>!</div>

<script>
    window.onload = function() {
        requestGPS();
        startTimer();
    };

    let componentRegistered = false;
    let startTime;
    let intervalId;
    let randomizePosition = false;
    let initialCoords;

    function requestGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                function(position) {
                    if (!componentRegistered) {
                        initialCoords = position.coords;
                        initARScene(position.coords);
                    }
                },
                function(error) {
                    handleGPSError(error);
                },
                { enableHighAccuracy: true, maximumAge: 500, timeout: 5000 }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    function handleGPSError(error) {
        switch (error.code) {
            case error.PERMISSION_DENIED:
                alert('GPS permission is required to use this application.');
                break;
            case error.POSITION_UNAVAILABLE:
                alert('Location information is unavailable. Please ensure your GPS is enabled.');
                break;
            case error.TIMEOUT:
                alert('The request to get user location timed out. Retrying...');
                setTimeout(requestGPS, 5000);
                break;
            default:
                alert('An unknown error occurred. Please try again.');
                break;
        }
    }

    function startTimer() {
        startTime = Date.now();
        intervalId = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        let currentTime = Date.now();
        let elapsedTime = currentTime - startTime;
        let seconds = Math.floor(elapsedTime / 1000) % 60;
        let minutes = Math.floor(elapsedTime / 60000);
        document.getElementById('debug-info').innerHTML += ` | Time: ${minutes}m ${seconds}s`;
    }

    function showEndScreen() {
        clearInterval(intervalId);
        let currentTime = Date.now();
        let elapsedTime = currentTime - startTime;
        let seconds = Math.floor(elapsedTime / 1000) % 60;
        let minutes = Math.floor(elapsedTime / 60000);
        document.getElementById('time-taken').innerText = `${minutes} minutes and ${seconds} seconds`;
        document.getElementById('end-screen').style.display = 'block';
    }

    function initARScene(coords) {
        let targetCoords = { latitude: 48.1401107, longitude: 14.2360109 };

        if (randomizePosition) {
            targetCoords = getRandomCoordinates(coords.latitude, coords.longitude, 500);
        }

        if (!componentRegistered) {
            AFRAME.registerComponent('check-distance', {
                tick: function() {
                    var boxEntity = document.querySelector('#info-box');
                    var debugInfo = document.querySelector('#debug-info');

                    var cameraPosition = this.el.components['gps-camera'].currentCoords;
                    var entityPosition = boxEntity.components['gps-entity-place'].attrValue;

                    if (cameraPosition && entityPosition) {
                        var distance = calculateDistance(cameraPosition.latitude, cameraPosition.longitude, entityPosition.latitude, entityPosition.longitude);
                        debugInfo.innerHTML = 'Distance: ' + distance.toFixed(2) + ' meters';

                        if (distance <= 5) {
                            showEndScreen();
                        }

                        // Make the entity always visible for debugging purposes
                        boxEntity.setAttribute('visible', true);
                    } else {
                        debugInfo.innerHTML = 'Distance: calculating...';
                    }
                }
            });
            componentRegistered = true;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // metres
            var φ1 = lat1 * Math.PI / 180;
            var φ2 = lat2 * Math.PI / 180;
            var Δφ = (lat2 - lat1) * Math.PI / 180;
            var Δλ = (lon2 - lon1) * Math.PI / 180;

            var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            var d = R * c; // in metres
            return d;
        }

        function getRandomCoordinates(lat, lon, radius) {
            var y0 = lat;
            var x0 = lon;
            var rd = radius / 111300; // about 111300 meters in one degree

            var u = Math.random();
            var v = Math.random();

            var w = rd * Math.sqrt(u);
            var t = 2 * Math.PI * v;
            var x = w * Math.cos(t);
            var y = w * Math.sin(t);

            var newLat = y + y0;
            var newLon = x + x0;
            return { latitude: newLat, longitude: newLon };
        }

        var scene = document.querySelector('a-scene');
        var camera = document.createElement('a-camera');
        camera.setAttribute('gps-camera', 'gpsMinDistance: 0; maxDistance: 10000');
        camera.setAttribute('rotation-reader', '');
        camera.setAttribute('check-distance', '');
        scene.appendChild(camera);

        var boxEntity = document.querySelector('#info-box');
        boxEntity.setAttribute('gps-entity-place', `latitude: ${targetCoords.latitude}; longitude: ${targetCoords.longitude};`);
    }
</script>
<a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
>
    <a-camera
            id="camera"
            gps-camera="gpsMinDistance: 0; maxDistance: 10000"
            rotation-reader=""
            check-distance=""
            rotation="0 0 0"
    ></a-camera>
    <a-text
            value="Hello World"
            id="info-box"
            color="red"
            scale="120 120 120"
            look-at="[gps-camera]"
            gps-entity-place="latitude: 48.1401107; longitude: 14.2360109;"
            visible="true"
    ></a-text>
    <arjs-debug></arjs-debug>
</a-scene>

</body>
</html>
